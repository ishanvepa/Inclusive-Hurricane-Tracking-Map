<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hurricane Sonification — Highcharts-only</title>

  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/sonification.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <script src="https://code.highcharts.com/modules/data.js"></script>

  <!-- Papa Parse (CSV convenience only; audio fully via Highcharts) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1220;--panel:#111a2b;--accent:#86b7ff;--muted:#9fb3c8;--text:#eaf2ff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    header{padding:20px 24px;border-bottom:1px solid #1a2947;background:linear-gradient(180deg,#0d1526,transparent)}
    h1{font-size:20px;margin:0 0 4px} .sub{color:var(--muted);font-size:13px}
    main{display:grid;grid-template-columns:380px 1fr;gap:20px;padding:20px}
    .card{background:var(--panel);border:1px solid #1a2947;border-radius:14px;padding:16px}
    .card h2{font-size:16px;margin:0 0 10px}
    .row{display:flex;align-items:center;gap:10px;margin:10px 0}
    label{font-size:13px;color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    input[type="file"], select, input[type="number"], input[type="range"]{width:100%;background:#0d1526;color:#eaf2ff;border:1px solid #253a66;border-radius:10px;padding:8px}
    button{background:#183664;border:1px solid #274f94;color:#eaf2ff;border-radius:10px;padding:10px 12px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px dashed #20355f;padding:6px 8px;text-align:left;color:#cfe0ff}
    .pill{font-size:11px;border:1px solid #274f94;padding:2px 6px;border-radius:999px;color:#cfe0ff;background:#0d1526}
    footer{padding:14px;color:#9fb3c8;border-top:1px solid #1a2947}
    .hint{font-size:12px;color:#9fb3c8}
    #container{height:520px;background:#0d1526;border:1px solid #1a2947;border-radius:14px}
  </style>
</head>
<body>
  <header>
    <h1>Hurricane Sonification Prototype (Highcharts)</h1>
    <div class="sub">Wind → woodwinds, Pressure → strings, Category → brass. Pan from lon, cadence from time scale, master volume, missing-value skips.</div>
  </header>

  <main>
    <section class="card" id="controls">
      <h2>Controls</h2>
      <div class="row">
        <label class="mono">CSV &nbsp;<span class="pill">time, lat, lon, wind, pressure, category</span></label>
        <input id="file" type="file" accept=".csv" />
      </div>
      <div class="row">
        <button id="btnSample">⇪ Load Sample (knots)</button>
        <button id="btnSample2">⇪ Load Sample (mph)</button>
        <button id="btnSample3">⇪ Load Sample (missing wind)</button>
      </div>
      <div class="row">
        <button id="btnPlay" disabled>▶ Play</button>
        <button id="btnPause" disabled>⏸ Pause</button>
        <button id="btnStop" disabled>⏹ Stop</button>
      </div>
      <div class="row">
        <label>Time scale (× per row)</label>
        <input id="timeScale" type="range" min="0.2" max="5" step="0.1" value="1" />
      </div>
      <div class="row">
        <label>Master volume (dB)</label>
        <input id="volume" type="range" min="-24" max="0" step="1" value="-6" />
      </div>
      <div class="row">
        <label>Pitch mapping for wind</label>
        <select id="pitchMap">
          <option value="linear" selected>Linear (higher wind → higher pitch)</option>
          <option value="semi">Semitone scale (quantized)</option>
        </select>
      </div>
      <div class="row">
        <label>Pressure mapping</label>
        <select id="pressMap">
          <option value="lp" selected>Low-pass + threshold (darker above)</option>
          <option value="gain">Lower pressure → louder</option>
          <option value="invertPitch">Lower pressure → lower pitch (darker)</option>
        </select>
      </div>
      <div class="row">
        <label for="pressThresh">Pressure LPF open threshold (mb)</label>
        <input id="pressThresh" type="range" min="940" max="1015" step="1" value="990" />
      </div>
      <div class="hint">Tip: Re-load a sample after changing mapping defaults to rebuild the series.</div>
    </section>

    <section class="card">
      <h2>Built-in Test Cases</h2>
      <ul>
        <li><strong>Sample (knots):</strong> 6 rows, TS→Cat 3, uses <code>wind_kt</code> & <code>mslp</code>.</li>
        <li><strong>Sample (mph):</strong> 6 rows; one row intentionally <em>missing pressure</em> — strings should <em>not</em> play there.</li>
        <li><strong>Sample (missing wind):</strong> 5 rows; one row intentionally <em>missing wind</em> — woodwinds & brass should <em>not</em> play there.</li>
      </ul>
    </section>

    <section class="card">
      <h2>Chart</h2>
      <div id="container"></div>
    </section>
  </main>

  <footer>
    <span>Mappings:</span>
    <ul>
      <li>Time → X order & total duration; Lon → stereo pan; Wind → woodwinds (pitch/rate/volume); Pressure → strings (volume or inverted-pitch); Category → brass motif</li>
    </ul>
  </footer>

<script>
(function () {
  // ---------- Utilities ----------
  function dbToGain(db){ return Math.pow(10, db / 20); }
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function num(v){ return (v===undefined||v===null||v==="") ? NaN : parseFloat(v); }
  function gKey(obj, key){
    if (!obj) return undefined;
    if (key in obj) return obj[key];
    var kl = (typeof key === 'string') ? key.toLowerCase() : '';
    return kl && (kl in obj) ? obj[kl] : undefined;
  }
  function mphFromWind(obj){
    var wind_mph = num(gKey(obj,'wind_mph') || gKey(obj,'max_wind_mph'));
    var wind_kt  = num(gKey(obj,'wind_kt')  || gKey(obj,'max_wind_kt') || gKey(obj,'vmax') || gKey(obj,'USA_WIND') || gKey(obj,'WMO_WIND') || gKey(obj,'wind'));
    return isFinite(wind_mph) ? wind_mph : (isFinite(wind_kt) ? wind_kt * 1.15078 : NaN);
  }
  function deriveCategoryFromWind(w_mph){
    var w = isFinite(w_mph) ? w_mph : 0;
    if (w >= 157) return 5;
    if (w >= 130) return 4;
    if (w >= 111) return 3;
    if (w >= 96)  return 2;
    if (w >= 74)  return 1;
    return 0;
  }
  function panFromLon(lon){
    var min=-100, max=-60; var t=clamp((lon-min)/(max-min), 0, 1);
    return t*2-1; // -1..+1
  }

  // ---------- State ----------
  var rows = [];
  var chart = null;

  // ---------- UI ----------
  var elFile       = document.getElementById('file');
  var elPlay       = document.getElementById('btnPlay');
  var elPause      = document.getElementById('btnPause');
  var elStop       = document.getElementById('btnStop');
  var elTimeScale  = document.getElementById('timeScale');
  var elVolume     = document.getElementById('volume');
  var elPitchMap   = document.getElementById('pitchMap');
  var elPressMap   = document.getElementById('pressMap');
  var elPressThresh= document.getElementById('pressThresh');

  // Samples
  var SAMPLE_CSV =
    "time,lat,lon,wind_kt,mslp\n" +
    "2018-10-09T00:00:00Z,24.5,-84.5,45,1005\n" +
    "2018-10-09T06:00:00Z,25.1,-84.2,55,998\n" +
    "2018-10-09T12:00:00Z,25.7,-83.9,65,990\n" +
    "2018-10-09T18:00:00Z,26.3,-83.5,85,974\n" +
    "2018-10-10T00:00:00Z,27.1,-83.0,100,960\n" +
    "2018-10-10T06:00:00Z,28.0,-82.6,115,948";

  var SAMPLE_CSV2 =
    "time,lat,lon,wind_mph,pressure\n" +
    "2018-10-09T00:00:00Z,24.5,-84.5,52,1008\n" +
    "2018-10-09T06:00:00Z,25.1,-84.2,63,1002\n" +
    "2018-10-09T12:00:00Z,25.7,-83.9,74,996\n" +
    "2018-10-09T18:00:00Z,26.3,-83.5,96,\n" +
    "2018-10-10T00:00:00Z,27.1,-83.0,111,970\n" +
    "2018-10-10T06:00:00Z,28.0,-82.6,130,955";

  var SAMPLE_CSV3 =
    "time,lat,lon,pressure\n" +
    "2018-10-09T00:00:00Z,24.5,-84.5,1008\n" +
    "2018-10-09T06:00:00Z,25.1,-84.2,1002\n" +
    "2018-10-09T12:00:00Z,25.7,-83.9,996\n" +
    "2018-10-09T18:00:00Z,26.3,-83.5,974\n" +
    "2018-10-10T00:00:00Z,27.1,-83.0,960";

  document.getElementById('btnSample').onclick  = function(){
    Papa.parse(SAMPLE_CSV,  {header:true, dynamicTyping:true, complete:onParsed});
  };
  document.getElementById('btnSample2').onclick = function(){
    Papa.parse(SAMPLE_CSV2, {header:true, dynamicTyping:true, complete:onParsed});
  };
  document.getElementById('btnSample3').onclick = function(){
    Papa.parse(SAMPLE_CSV3, {header:true, dynamicTyping:true, complete:onParsed});
  };

  elFile.addEventListener('change', function (e) {
    var f = e.target.files && e.target.files[0];
    if (!f) return;
    Papa.parse(f, {header:true, dynamicTyping:true, skipEmptyLines:true, complete:onParsed});
  });

  function onParsed(res){
    rows = res.data.map(function (o, i){
      var wind = mphFromWind(o);
      var pressure = num(gKey(o,'pressure') || gKey(o,'mslp') || gKey(o,'pmin') || gKey(o,'USA_PRES') || gKey(o,'WMO_PRES'));
      var catRaw = parseInt(gKey(o,'category') || gKey(o,'cat') || gKey(o,'sshws'));
      var category = isFinite(catRaw) ? catRaw : (isFinite(wind) ? deriveCategoryFromWind(wind) : null);
      var lat = num(gKey(o,'lat') || gKey(o,'latitude'));
      var lon = num(gKey(o,'lon') || gKey(o,'longitude') || gKey(o,'lng'));
      var t   = gKey(o,'time') || gKey(o,'timestamp') || gKey(o,'date') || gKey(o,'ISO_time') || null;
      return { i, t, lat, lon, wind, pressure, category };
    }).filter(function (r){ return isFinite(r.lat) && isFinite(r.lon); });

    buildChart();
    enableTransport(true);
  }

  function enableTransport(ready){
    elPlay.disabled = !ready;
    elPause.disabled = !ready;
    elStop.disabled = !ready;
  }

  // ---------- Chart + Sonification ----------
  function measureMs(){
    // Match your prior "800ms per row" conductor, scaled by slider
    var base = 800;
    var scale = parseFloat(elTimeScale.value || '1');
    return base / scale;
  }

  function buildChart(){
    if (!rows.length) return;

    // Precompute point arrays for three logical series (wind/pressure/category)
    var windSeries = [], pressSeries = [], catSeries = [];

    rows.forEach(function(r, idx){
      // Common X: row index; keep lon/lat as props for mapping functions
      var basePoint = { x: idx, lon: r.lon, lat: r.lat, timeISO: r.t };

      // Wind (skip if missing)
      if (isFinite(r.wind)) {
        windSeries.push(Object.assign({ y: r.wind }, basePoint));
      } else {
        windSeries.push(null); // preserves timeline position; mapping functions can detect null
      }

      // Pressure (skip if missing)
      if (isFinite(r.pressure)) {
        pressSeries.push(Object.assign({ y: r.pressure }, basePoint));
      } else {
        pressSeries.push(null);
      }

      // Category (skip if null/NaN)
      if (r.category !== null && r.category !== undefined && isFinite(r.category)) {
        catSeries.push(Object.assign({ y: r.category }, basePoint));
      } else {
        catSeries.push(null);
      }
    });

    // Calculate total sonification duration from measure * rows
    var totalDuration = Math.max(500, Math.round(rows.length * measureMs()));

    // Master gain (Highcharts exposes 'masterVolume' at chart level via sonification.options)
    var masterGain = dbToGain(parseFloat(elVolume.value));

    // Mapping helpers (functions receive a context with point/value/time) :contentReference[oaicite:1]{index=1}
    var pitchMapMode = elPitchMap.value;   // linear | semi
  var pressMode    = elPressMap.value;   // lp | gain | invertPitch

    // Woodwinds (wind) mapping
    function windPitch(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return null;
      var w = ctx.point.y; // mph
      if (pitchMapMode === 'semi') {
        // Map to semitone steps roughly 220Hz base + up to ~2 octaves
        var semis = clamp(Math.round((w / 160) * 24), 0, 24);
        // Highcharts accepts note names OR Hz; give note name near A3..A5 :contentReference[oaicite:2]{index=2}
        var noteNames = ['A3','A#3','B3','C4','C#4','D4','D#4','E4','F4','F#4','G4','G#4','A4','A#4','B4','C5','C#5','D5','D#5','E5','F5','F#5','G5','G#5','A5'];
        return noteNames[semis];
      }
      // Linear Hz 100..900
      return 100 + (clamp(w, 0, 160) / 160) * 800;
    }
    function windRate(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return 0;
      var w = clamp(ctx.point.y, 0, 160);
      // More wind => faster note triggering (trill feel)
      return 0.5 + (w / 160) * 3.0; // 0.5 .. 3.5 events per "window"
    }
    function windVol(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return 0;
      var w = clamp(ctx.point.y, 0, 160);
      return 0.15 + (w/160) * 0.6;
    }

    // Strings (pressure) mapping
    function pressVol(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return 0;
      var p = ctx.point.y; // mb
      var delta = Math.max(0, 1015 - p);
      return clamp(0.15 + (delta / 60), 0, 1); // lower pressure → louder
    }
    function pressPitch(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return null;
      var p = ctx.point.y;
      // Invert: lower pressure → lower pitch (55..110 Hz)
      var t = clamp((1020 - p) / 100, 0, 1);
      return 110 - t*55;
    }

    // Pressure → Low-pass + threshold (simulated)
    function pressBaseVol(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return 0;
      var p = ctx.point.y; // mb
      var delta = Math.max(0, 1015 - p);
      // Quiet bed that grows a bit as pressure drops (dark, LPF-like)
      return clamp(0.08 + (delta / 120), 0, 0.5);
    }
    function pressBrightVol(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return 0;
      var p = ctx.point.y;
      var th = parseFloat(elPressThresh && elPressThresh.value || '990');
      // Opens only when pressure goes below threshold
      var open = clamp((th - p) / 60, 0, 1); // 0 above threshold → 1 well below
      return open; // acts like a brightness gate opening
    }
    function pressBrightPitch(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return null;
      var p = ctx.point.y;
      var th = parseFloat(elPressThresh && elPressThresh.value || '990');
      // Slightly higher pitch the further below threshold we are (brighter impression)
      var t = clamp((th - p) / 80, 0, 1);
      return 260 + t * 180; // ~260..440 Hz
    }

    // Brass (category) mapping
    function catPitch(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return null;
      var motifs = {
        0: [0],
        1: [0],
        2: [0,7],
        3: [0,3,7],
        4: [0,2,5,7],
        5: [0,2,3,6,10]
      };
      var baseHz = 220;
      var cat = clamp(Math.round(ctx.point.y), 0, 5);
      // Return base for first subnote; subsequence will be handled via noteDuration/rate trick
      return baseHz * Math.pow(2, motifs[cat][0]/12);
    }
    function catVol(ctx){
      if (!ctx.point || !isFinite(ctx.point.y)) return 0;
      var c = clamp(Math.round(ctx.point.y), 0, 5);
      return Math.min(1, 0.3 + (c * 0.14));
    }

    function pan(ctx){
      if (!ctx.point || !isFinite(ctx.point.lon)) return 0;
      return panFromLon(ctx.point.lon);
    }

    // Build chart
    if (chart) { chart.destroy(); }

    chart = Highcharts.chart('container', {
      chart: { backgroundColor: '#0d1526' },
      title: { text: 'Hurricane Sonification (Highcharts)', style: { color: '#eaf2ff' } },
      xAxis: { title: { text: 'Step' }, gridLineColor: '#1a2947', tickColor: '#1a2947' },
      yAxis: [{ title: { text: 'Wind / Pressure / Category' }, gridLineColor: '#1a2947' }],
      legend: { itemStyle: { color: '#cfe0ff' } },
      tooltip: { shared: true },
      sonification: {
        enabled: true,
        duration: totalDuration,            // total playback time :contentReference[oaicite:3]{index=3}
        order: 'simultaneous',              // play tracks together :contentReference[oaicite:4]{index=4}
        masterVolume: masterGain,           // chart-level gain (0..1)
        defaultInstrumentOptions: {
          // defaults can be overridden per-track
          mapping: {
            time: 'x'                       // default: lowest x → earliest :contentReference[oaicite:5]{index=5}
          }
        },
        // Optional global context ticks (metronome feel)
        globalContextTracks: [{
          type: 'instrument',
          instrument: 'sine',
          mapping: {
            time: { valueInterval: totalDuration / rows.length },
            noteDuration: { value: 60 },
            volume: { value: 0.08 },
            pan
          }
        }],
        events: {
          onStop: function(){ /* could toggle buttons here */ } // :contentReference[oaicite:6]{index=6}
        }
      },
      series: [
        // --- Wind → woodwinds (triangle/flute-like)
        {
          name: 'Wind (mph)',
          type: 'line',
          data: windSeries,
          color: '#86b7ff',
          sonification: {
            tracks: [{
              type: 'instrument',
              instrument: 'flute',         // preset string or config object :contentReference[oaicite:7]{index=7}
              mapping: {
                pitch: windPitch,          // function mapping supported
                rate:  windRate,           // faster = more notes per window
                volume: windVol,
                pan:   pan,
                noteDuration: { value: 90 } // short, trill-like
              }
            }]
          }
        },

        // --- Pressure → strings (saw/pad-like)
        {
          name: 'Pressure (mb)',
          type: 'line',
          data: pressSeries,
          color: '#ffcf86',
          sonification: (function(){
            if (pressMode === 'lp') {
              // Two-layer approach: dark base + bright layer that opens below threshold
              return {
                tracks: [
                  {
                    type: 'instrument',
                    instrument: 'triangle',
                    mapping: {
                      pitch: { value: 180 },
                      volume: pressBaseVol,
                      pan: pan,
                      noteDuration: { value: 380 }
                    }
                  },
                  {
                    type: 'instrument',
                    instrument: 'sawtooth',
                    mapping: {
                      pitch: pressBrightPitch,
                      volume: pressBrightVol,
                      pan: pan,
                      noteDuration: { value: 240 }
                    }
                  }
                ]
              };
            }
            if (pressMode === 'gain') {
              return {
                tracks: [{
                  type: 'instrument',
                  instrument: 'sawtooth',
                  mapping: {
                    pitch: { value: 220 }, // constant pitch, let volume carry intensity
                    volume: pressVol,
                    pan: pan,
                    noteDuration: { value: 300 }
                  }
                }]
              };
            }
            // invertPitch
            return {
              tracks: [{
                type: 'instrument',
                instrument: 'sawtooth',
                mapping: {
                  pitch: pressPitch,
                  volume: { value: 0.4 },
                  pan: pan,
                  noteDuration: { value: 300 }
                }
              }]
            };
          })()
        },

        // --- Category → brass motif (square/saw; louder at higher category)
        {
          name: 'Category (SSHWS)',
          type: 'line',
          data: catSeries,
          color: '#ff8a86',
          sonification: {
            tracks: [{
              type: 'instrument',
              instrument: 'square',
              mapping: {
                pitch: catPitch,
                volume: catVol,
                pan: pan,
                // break motif into quick sub-notes by higher rate at higher cat
                rate: function(ctx){
                  if (!ctx.point || !isFinite(ctx.point.y)) return 0;
                  return 1 + (clamp(Math.round(ctx.point.y), 0, 5) * 0.8);
                },
                noteDuration: { value: 120 }
              }
            }]
          }
        }
      ]
    });
  }

  // Transport buttons -> Highcharts sonification controls (play/pause/cancel) :contentReference[oaicite:8]{index=8}
  elPlay.onclick  = function(){ if (chart) chart.sonify(); };
  elPause.onclick = function(){ if (chart) chart.pauseSonify && chart.pauseSonify(); };
  elStop.onclick  = function(){ if (chart) chart.cancelSonify && chart.cancelSonify(true); };

  // Live update of master volume & time scale
  elVolume.addEventListener('input', function(){
    if (!chart) return;
    var opts = chart.options.sonification || {};
    opts.masterVolume = dbToGain(parseFloat(elVolume.value));
    chart.update({ sonification: { masterVolume: opts.masterVolume } }, false);
  });
  elTimeScale.addEventListener('input', function(){
    if (!chart || !rows.length) return;
    var totalDuration = Math.max(500, Math.round(rows.length * measureMs()));
    chart.update({ sonification: { duration: totalDuration } }, false);
  });

  // Rebuild chart live when adjusting pressure LPF threshold
  if (elPressThresh) {
    elPressThresh.addEventListener('input', function(){
      if (rows && rows.length) { buildChart(); }
    });
  }

})();
</script>
</body>
</html>
